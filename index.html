<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hỗ trợ BHXH Cà Mau</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* GIỮ NGUYÊN GIAO DIỆN CŨ */
        body { font-family: 'Roboto', sans-serif; background-color: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        #chatbot-container { width: 100%; max-width: 800px; height: 90vh; background: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; flex-direction: column; overflow: hidden; }
        #chat-header { background: #ffffff; border-bottom: 1px solid #e0e0e0; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header-info { display: flex; align-items: center; gap: 15px; }
        .logo-placeholder { width: 40px; height: 40px; background-color: #1a56db; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .titles h1 { margin: 0; font-size: 16px; color: #1a56db; text-transform: uppercase; font-weight: 700; }
        .titles p { margin: 2px 0 0 0; font-size: 12px; color: #666; font-weight: 500; }
        .status-badge { background-color: #e6f4ea; color: #1e8e3e; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .dot { width: 8px; height: 8px; background-color: #1e8e3e; border-radius: 50%; }
        #chat-body { flex: 1; padding: 20px; background-color: #f9fafb; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }
        .user-msg-container { align-self: flex-end; max-width: 70%; }
        .user-msg { background-color: #1a56db; color: white; padding: 12px 16px; border-radius: 8px; font-size: 14px; line-height: 1.5; }
        .msg-time { font-size: 11px; color: #ffffff; opacity: 0.8; margin-top: 5px; text-align: right; display: block; }
        .bot-msg-container { align-self: flex-start; max-width: 85%; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; }
        .bot-msg { color: #333; font-size: 14px; line-height: 1.6; }
        .bot-msg strong { color: #000; font-weight: 700; }
        .bot-msg p { margin-bottom: 10px; }
        #input-area { padding: 15px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; outline: none; }
        button { padding: 10px 25px; background-color: #1a56db; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        button:hover { background-color: #1545b3; }
    </style>
</head>
<body>

<div id="chatbot-container">
    <div id="chat-header">
        <div class="header-info">
            <div class="logo-placeholder">BH</div>
            <div class="titles">
                <h1>BẢO HIỂM XÃ HỘI TỈNH CÀ MAU</h1>
                <p>HỆ THỐNG HỖ TRỢ TRA CỨU TỰ ĐỘNG V2.2</p>
            </div>
        </div>
        <div class="status-badge"><span class="dot"></span> Trực tuyến</div>
    </div>

    <div id="chat-body">
        <div class="bot-msg-container">
            <div class="bot-msg">
                Xin chào! Tôi là trợ lý ảo BHXH tỉnh Cà Mau. Tôi có thể giúp gì cho bạn?
            </div>
        </div>
    </div>

    <div id="input-area">
        <input id="chat-input" type="text" placeholder="Nhập nội dung cần tư vấn...">
        <button id="send-btn">Gửi</button>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- CẤU HÌNH API KEY TẠI ĐÂY ---
        // Hãy dán key của bạn vào giữa hai dấu nháy đơn bên dưới
        const API_KEY = 'AIzaSyB_DDXloIeUQB-qZo-GVYdoMdTA8DwpimQ'; 
        // -------------------------------

        const chatBody = document.getElementById('chat-body');
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');

        function getTime() {
            const now = new Date();
            return now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }) + " | Hệ thống";
        }

        function appendUserMessage(text) {
            const div = document.createElement('div');
            div.className = 'user-msg-container';
            div.innerHTML = `<div class="user-msg">${text}<span class="msg-time">${getTime()}</span></div>`;
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function appendBotMessage(htmlContent) {
            const div = document.createElement('div');
            div.className = 'bot-msg-container';
            div.innerHTML = `<div class="bot-msg">${htmlContent}</div>`;
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        async function send() {
            // Lấy nội dung từ ô nhập liệu
            const text = chatInput.value.trim(); 
            if (!text) return;

            // Nếu chưa nhập API Key thì báo lỗi
            if (API_KEY === 'DÁN_API_KEY_CỦA_BẠN_VÀO_ĐÂY' || API_KEY === '') {
                alert("Bạn chưa nhập API Key vào trong code!");
                return;
            }

            appendUserMessage(text);
            chatInput.value = '';

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'bot-msg-container';
            loadingDiv.innerHTML = '<i>Đang tra cứu dữ liệu...</i>';
            chatBody.appendChild(loadingDiv);
            chatBody.scrollTop = chatBody.scrollHeight;

            try {
                // GỌI TRỰC TIẾP GOOGLE (Không qua Cloudflare Worker nữa)
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            role: "user",
                            parts: [{ text: `
          Bạn là Chuyên gia tư vấn cấp cao của BHXH tỉnh Cà Mau (mới), quản lý khu vực hợp nhất Bạc Liêu – Cà Mau.
          
          Bối cảnh:
          - Hai tỉnh Bạc Liêu và Cà Mau đã hợp nhất từ 04/2025.
          - Từ 07/2025, toàn bộ thủ tục BHXH do BHXH tỉnh Cà Mau (mới) quản lý.
          - Người dân Bạc Liêu cũ vẫn sử dụng thẻ BHYT, mã BHXH bình thường.
          
          Nhiệm vụ:
          - Tư vấn chính sách BHXH, BHYT, BHTN tại Việt Nam.
          - Ưu tiên hướng dẫn áp dụng tại tỉnh Cà Mau (mới).
          - Giải thích rõ ràng, đúng văn phong hành chính.
          
          Quy tắc:
          - Không dùng emoji
          - Không xưng hô thân mật
          - Trình bày gạch đầu dòng
          - Khi liên quan pháp luật, luôn kết thúc bằng:
          "Thông tin mang tính tham khảo, thực hiện theo văn bản chính thức của BHXH Việt Nam."
          
          ---  
          Câu hỏi của người dân:
          ${text}
          ` }] // Dùng biến 'text' đã lấy ở trên, KHÔNG DÙNG 'input'
                        }]
                    })
                });

                const data = await response.json();
                if (loadingDiv.parentNode) chatBody.removeChild(loadingDiv);

                if (data.candidates && data.candidates[0].content) {
                    const reply = data.candidates[0].content.parts[0].text;
                    // Chuyển đổi dấu xuống dòng thành thẻ <br> để hiển thị đẹp
                    const formattedReply = reply.replace(/\n/g, '<br>');
                    appendBotMessage(formattedReply);
                } else if (data.error) {
                    appendBotMessage(`<b style="color:red">Lỗi API:</b> ${data.error.message}`);
                } else {
                    appendBotMessage("Không nhận được phản hồi từ AI.");
                }

            } catch (error) {
                if (loadingDiv.parentNode) chatBody.removeChild(loadingDiv);
                appendBotMessage(`<span style="color:red">Lỗi kết nối: ${error.message}</span>`);
            }
        }

        // Gán sự kiện
        if (sendBtn) sendBtn.addEventListener('click', send);
        if (chatInput) {
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') send();
            });
        }
    });
</script>

</body>
</html>
